<div class="container mt-4">
  <h2>Editar Pedido</h2>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- ============================= -->
    <!-- Datos del pedido -->
    <!-- ============================= -->
    <h4>Datos del Pedido</h4>
    {{ pedido_form.as_p }}

    {% if resultado %}
      <p class="text-success">{{ resultado }}</p>
    {% endif %}
    {% if error %}
      <p class="text-danger">{{ error }}</p>
    {% endif %}

    <!-- ============================= -->
    <!-- Productos -->
    <!-- ============================= -->
    <h4>Productos</h4>

    {{ formset.management_form }}

    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Tamaño</th>
          <th>Observación</th>
          <th>Stock</th>
          <th>Precio Unitario</th>
          <th>Subtotal</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody>
        {% for form in formset %}
          <tr>
            <td>{{ form.nombre_producto }}</td>
            <td>{{ form.tipo_producto }}</td>
            <td>{{ form.tamano_producto }}</td>
            <td>{{ form.observacion_producto }}</td>
            <td>{{ form.cantidad_producto }}</td>
            <td>{{ form.precio_unitario_producto }}</td>
            <td class="subtotal">0</td>
            <td class="text-center">{% if form.DELETE %}{{ form.DELETE }}{% endif %}</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="6" class="text-end">Total Neto:</th>
          <th id="total-neto">0</th>
          <th colspan="1" class="text-end">Total + IVA:</th>
          <th id="total-iva">0</th>
        </tr>
      </tfoot>
    </table>

    <button type="button" id="add-product" class="btn btn-success mb-3">Añadir Producto</button>
    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
  </form>
</div>

<!-- ============================= -->
<!-- Script para clonar fila de productos -->
<!-- ============================= -->
<script>
const addButton = document.getElementById('add-product');
const totalForms = document.querySelector('#id_productos-TOTAL_FORMS');
const tableBody = document.querySelector('table tbody');

addButton.addEventListener('click', () => {
    let formNum = parseInt(totalForms.value);

    let lastRow = tableBody.querySelector('tr:last-child');
    let newRow = lastRow ? lastRow.cloneNode(true) : document.createElement('tr');

    newRow.querySelectorAll('input, select, textarea').forEach(input => {
        if(input.name){
            input.name = input.name.replace(/-\d+-/, `-${formNum}-`);
            input.id = input.id.replace(/-\d+-/, `-${formNum}-`);
        }
        if(input.type === 'checkbox') input.checked = false;
        else input.value = '';
    });

    // Resetear subtotal
    const tdSubtotal = newRow.querySelector('.subtotal');
    if(tdSubtotal) tdSubtotal.textContent = '0';

    tableBody.appendChild(newRow);
    totalForms.value = formNum + 1;
    actualizarTotales();
});
</script>

<!-- ============================= -->
<!-- Script para actualizar totales dinámicamente -->
<!-- ============================= -->
<script>
function actualizarTotales() {
    let totalNeto = 0;
    let totalIVA = 0;
    tableBody.querySelectorAll('tr').forEach(row => {
        const cantidad = parseFloat(row.querySelector('[name$="cantidad_producto"]').value) || 0;
        const precio = parseFloat(row.querySelector('[name$="precio_unitario_producto"]').value) || 0;
        const subtotal = cantidad * precio;
        const tdSubtotal = row.querySelector('.subtotal');
        if(tdSubtotal) tdSubtotal.textContent = subtotal.toFixed(2);
        totalNeto += subtotal;
        totalIVA += subtotal * 1.19; // IVA 19%
    });
    document.getElementById('total-neto').textContent = totalNeto.toFixed(2);
    document.getElementById('total-iva').textContent = totalIVA.toFixed(2);
}

// Llamar cada vez que cambie cantidad o precio
tableBody.addEventListener('input', e => {
    if(e.target.name.endsWith('cantidad_producto') || e.target.name.endsWith('precio_unitario_producto')){
        actualizarTotales();
    }
});

// Inicializar totales al cargar la página
actualizarTotales();
</script>
