{% extends 'Home/base.html' %}
{% load static %}

{% block title %}Lista de Pedidos{% endblock %}

{% block extra_css %}
<style>
    #tablaPedidos {
        font-size: 14px;
    }
    #tablaPedidos td, #tablaPedidos th {
        padding: 10px; 
        vertical-align: middle; 
    }
</style>
{% endblock %}

{% block content %}

<div class="container my-5">
    <h1>Lista de Pedidos</h1>
    
    <div class="table-responsive">
        <table id="tablaPedidos" class="table table-striped table-hover" style="width:100%">
            <thead>
                <tr>
                    <th>Código Pedido</th>
                    <th>Cliente</th>
                    <th>Fecha Pedido</th>
                    <th>Total Neto</th>
                    <th>IVA</th>
                    <th>Total Pedido</th>
                    <th class="text-center">Productos</th>
                    <th class="text-center">Facturas</th>
                    <th class="text-center">Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for pedido in pedidos %}
                <tr>
                    <td>{{ pedido.cod_pedido }}</td>
                    <td>{{ pedido.cliente.razon_social_cliente }}</td>
                    <td>{{ pedido.fecha_pedido }}</td>
                    <td>{{ pedido.total_neto_pedido }}</td>
                    <td>{{ pedido.iva_pedido }}</td>
                    <td>{{ pedido.total_pedido }}</td>
                    
                    <td class="text-center">
                        <button 
                            type="button" 
                            class="btn btn-info btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#productosModal_{{ pedido.id }}" 
                        >
                            Detalle ({{ pedido.producto_set.count }})
                        </button>
                    </td>
                    
                    <td class="text-center">
                         <button 
                            type="button" 
                            class="btn btn-warning btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#facturasModal_{{ pedido.id }}" 
                        >
                            Facturas ({{ pedido.factura_set.count }})
                        </button>
                    </td>
                    
                    <td>
                        <a href="{% url 'pedidos:pdf_un_pedido' pedido.id %}" class="btn btn-success btn-sm mb-1" target="_blank">Generar PDF</a>
                        <a href="{% url 'pedidos:editar_pedido' pedido.id %}" class="btn btn-warning btn-sm mb-1">Editar Pedido</a>
                        <a href="{% url 'facturas:ingresar_factura' pedido.id %}" class="btn btn-primary btn-sm">Ingresar Factura</a>
                        <a href="{% url 'despachos:ingresar_guia' pedido.id %}" class="btn btn-info btn-sm mb-1">Ingresar Guía</a>
                        <a href="{% url 'pedidos:exportar_pedido_excel' pedido.id %}" class="btn btn-success">
                            Exportar a Excel
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <a href="{% url 'pedidos:exportar_excel' %}" class="btn btn-success">
        Descargar Excel
    </a>
</div>


<!-- Cambiar por modal Ajax -->
{% for pedido in pedidos %}
    {% include "pedidos/modals/modal_productos.html" %}
    {% include "pedidos/modals/modal_facturas.html" %}
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Inicialización de DataTables
        $('#tablaPedidos').DataTable({
            language: {
                url: '{% static "vendor/datatables/i18n/es-ES.json" %}',
            },
            columnDefs: [
                { targets: 6, orderable: false, searchable: false }, // Productos
                { targets: 7, orderable: false, searchable: false }, // Facturas
                { targets: 8, orderable: false, searchable: false }  // Acción
            ]
        });
    });
</script>

<!-- Insertar el script que llama al modal con Ajax -->
{% endblock %}