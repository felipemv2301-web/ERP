{% extends 'Home/base.html' %}
{% load static %}

{% block title %}Lista de Pedidos{% endblock %}

{% block extra_css %}
<style>
    #tablaPedidos {
        font-size: 14px;
    }
    #tablaPedidos td, #tablaPedidos th {
        padding: 10px; 
        vertical-align: middle; 
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <h1>Lista de Pedidos</h1>
    
    <div class="table-responsive">
        <table id="tablaPedidos" class="table table-striped table-hover" style="width:100%">
            <thead>
                <tr>
                    <th>Código Pedido</th>
                    <th>Cliente</th>
                    <th>Fecha Pedido</th>
                    <th>Total Neto</th>
                    <th>IVA</th>
                    <th>Total Pedido</th>
                    <th class="text-center">Productos</th>
                    <th class="text-center">Facturas</th>
                    <th class="text-center">Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for pedido in pedidos %}
                <tr>
                    <td>{{ pedido.cod_pedido }}</td>
                    <td>{{ pedido.cliente.razon_social_cliente }}</td>
                    <td>{{ pedido.fecha_pedido }}</td>
                    <td>{{ pedido.total_neto_pedido }}</td>
                    <td>{{ pedido.iva_pedido }}</td>
                    <td>{{ pedido.total_pedido }}</td>
                    
                    <td class="text-center">
                        <button type="button" class="btn btn-info btn-sm btn-ver-productos" data-id="{{ pedido.id }}">
                            Detalle ({{ pedido.producto_set.count }})
                        </button>
                    </td>
                    
                    <td class="text-center">
                        <button 
                            type="button" 
                            class="btn btn-warning btn-sm btn-ver-facturas" 
                            data-id="{{ pedido.id }}"
                        >
                            Facturas ({{ pedido.factura_set.count }})
                        </button>
                    </td>
                    
                    <td>
                        <a href="{% url 'pedidos:pdf_un_pedido' pedido.id %}" class="btn btn-success btn-sm mb-1" target="_blank">Generar PDF</a>
                        <a href="{% url 'pedidos:editar_pedido' pedido.id %}" class="btn btn-warning btn-sm mb-1">Editar Pedido</a>
                        <a href="{% url 'facturas:ingresar_factura' pedido.id %}" class="btn btn-primary btn-sm">Ingresar Factura</a>
                        <a href="{% url 'despachos:ingresar_guia' pedido.id %}" class="btn btn-info btn-sm mb-1">Ingresar Guía</a>
                        <button type="button" class="btn btn-secondary btn-sm btn-ver-despachos" data-id="{{ pedido.id }}">
                            Despachos ({{ pedido.guia_despacho_set.count }})
                        </button>
                        <a href="{% url 'pedidos:exportar_pedido_excel' pedido.id %}" class="btn btn-success">
                            Exportar a Excel
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <a href="{% url 'pedidos:exportar_excel' %}" class="btn btn-success mt-3">
        Descargar Excel
    </a>
</div>

{% for pedido in pedidos %}
<!-- Modal Productos -->
<div class="modal fade" id="productosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Productos de: {{ pedido.cod_pedido }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="productosModalBody">
        <div class="text-center py-5">
          <i class="fas fa-spinner fa-spin fa-2x"></i> Cargando...
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Facturas -->
<div class="modal fade" id="facturasModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Facturas del Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="facturasModalBody">
        <div class="text-center py-5">
          <i class="fas fa-spinner fa-spin fa-2x"></i> Cargando...
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Despachos -->
<div class="modal fade" id="despachosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Despachos del Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="despachosModalBody">
        <div class="text-center py-5">
          <i class="fas fa-spinner fa-spin fa-2x"></i> Cargando...
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inicializar DataTables
    $('#tablaPedidos').DataTable({
        language: { url: '{% static "vendor/datatables/i18n/es-ES.json" %}' },
        columnDefs: [
            { targets: 6, orderable: false, searchable: false },
            { targets: 7, orderable: false, searchable: false },
            { targets: 8, orderable: false, searchable: false }
        ]
    });

    // AJAX Productos
    $('.btn-ver-productos').on('click', function() {
        let pedidoId = $(this).data('id');
        $('#productosModal').modal('show');
        $('#productosModalBody').html('<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x"></i> Cargando...</div>');

        $.ajax({
            url: '/pedidos/pedido/' + pedidoId + '/modal_productos/',
            success: function(data) { $('#productosModalBody').html(data); },
            error: function() { $('#productosModalBody').html('<p class="text-danger text-center">Error cargando productos.</p>'); }
        });
    });

    // AJAX Facturas
    $(document).ready(function(){
        $('.btn-ver-facturas').on('click', function(){
            let pedidoId = $(this).data('id');
            $('#facturasModal').modal('show');
            $('#facturasModalBody').html('<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x"></i> Cargando...</div>');

            $.ajax({
                url: '/pedidos/pedido/' + pedidoId + '/modal_facturas/',
                success: function(data){
                    $('#facturasModalBody').html(data);
                },
                error: function(){
                    $('#facturasModalBody').html('<p class="text-danger text-center">Error cargando facturas.</p>');
                }
            });
        });
    });

    // AJAX Despachos
    $('.btn-ver-despachos').on('click', function() {
        let pedidoId = $(this).data('id');
        $('#despachosModal').modal('show');
        $('#despachosModalBody').html('<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x"></i> Cargando...</div>');

        $.ajax({
            url: '/pedidos/pedido/' + pedidoId + '/modal_despachos/',
            success: function(data) { $('#despachosModalBody').html(data); },
            error: function() { $('#despachosModalBody').html('<p class="text-danger text-center">Error cargando despachos.</p>'); }
        });
    });
});
</script>
{% endblock %}
